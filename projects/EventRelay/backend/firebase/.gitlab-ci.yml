# GitLab CI/CD Pipeline for Firebase Project
# Comprehensive DevOps pipeline with all Phase 3 systems

stages:
  - validate
  - test
  - build
  - deploy
  - monitor

variables:
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_DRIVER: overlay2

# ===== VALIDATION STAGE =====
validate:docs:
  stage: validate
  image: node:18-alpine
  before_script:
    - apk add --no-cache git
    - npm ci
  script:
    - echo "ğŸ” Validating documentation..."
    - npm run docs:validate
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - Docs/maintenance-report.*
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

validate:security:
  stage: validate
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "ğŸ”’ Running security validation..."
    - npm run security:audit
    - npm run security:lint
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# ===== TESTING STAGE =====
test:unit:
  stage: test
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "ğŸ§ª Running unit tests..."
    - npm run test:unit
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: test-results/unit/junit-*.xml
    paths:
      - coverage/
      - test-results/unit/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

test:integration:
  stage: test
  image: node:18-alpine
  services:
    - postgres:15-alpine
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    REDIS_URL: redis://redis:6379
  before_script:
    - npm ci
    - npm run db:migrate:test
  script:
    - echo "ğŸ”— Running integration tests..."
    - npm run test:integration
  artifacts:
    reports:
      junit: test-results/integration/junit-*.xml
    paths:
      - test-results/integration/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

# ===== MONITORING STAGE =====
monitor:health:
  stage: monitor
  image: node:18-alpine
  script:
    - echo "ğŸ¥ Running health checks..."
    - npm run monitoring:status
    - npm run analytics:status
  only:
    - main
    - develop
  when: manual

monitor:compliance:
  stage: monitor
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "âš–ï¸ Running compliance checks..."
    - npm run compliance:check
  artifacts:
    paths:
      - reports/compliance/
    expire_in: 1 week
  only:
    - main
  when: manual

# ===== SCHEDULED JOBS =====
scheduled:maintenance:
  stage: monitor
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "ğŸ”§ Running scheduled maintenance..."
    - npm run docs:weekly-review
    - npm run security:scan
  only:
    schedules:
      - "0 2 * * 1"  # Every Monday at 2 AM
  when: manual

scheduled:analytics:
  stage: monitor
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "ğŸ“Š Running analytics processing..."
    - npm run analytics:report
    - npm run risk:report
  artifacts:
    paths:
      - reports/analytics/
    expire_in: 1 week
  only:
    schedules:
      - "0 6 * * *"  # Daily at 6 AM
  when: manual

# ===== MANUAL JOBS =====
manual:full-system-test:
  stage: monitor
  image: node:18-alpine
  before_script:
    - npm ci
  script:
    - echo "ğŸ§ª Running full system test..."
    - npm run test:unit
    - npm run test:integration
    - npm run docs:validate
    - npm run compliance:check
    - npm run security:scan
  artifacts:
    paths:
      - test-results/
      - reports/
    expire_in: 1 week
  when: manual
  allow_failure: true
